<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>房型收藏</title>
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- SweetAlert2 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/7.2.0/sweetalert2.min.css"
    />
    <!-- AOS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/aos/3.0.0-beta.6/aos.css"
      integrity="sha512-hoGlO+71fSG6lgS60I4bKvsFVB+bAnrVFDYlwSXoyNLppDcoupwJB7KbWq/63iACKn3gcgK9jMXd+T+YDeVrGQ=="
      crossorigin="anonymous"
    />
    <!-- bootstrap -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../../styles/bootstrap4/bootstrap.min.css"
    />
    <!-- font-awesome -->
    <link
      href="../../plugins/font-awesome-4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <!-- breadcrumbs -->
    <link
    rel="stylesheet"
    type="text/css"
    href="../../styles//breadcrumbs.css"
    />
    <!-- base css -->
    <link rel="stylesheet" type="text/css" href="../../styles/base.css" />
    <!-- room css -->
    <link rel="stylesheet" type="text/css" href="../../styles/room/room.css" />
  </head>
  <style>
.comment {
	font-size:40px;
	color:orange;
  height: 50px;

}
.comment li {
	float:left;
  cursor: pointer;
}
ul {
	list-style:none;
}
.pagination{
justify-content: center;
margin-top:40px

}

  </style>
  <body>
  <!-- Header -->
  <div id="header"></div>
  <!-- Header -->
  <div class="container body">
    <!-- Breadcrumbs_start -->
		<div class="row">
			<div class="col">
				<div class="breadcrumbs d-flex flex-row align-items-center">
					<ul>
						<li><a href="index.html">首頁</a></li>
						<li><a href="./myroom.html"><i class="fa fa-angle-right" aria-hidden="true"></i>會員中心</a></li>
						<li class="active"><a href="#"><i class="fa fa-angle-right" aria-hidden="true"></i>訂單明細</a></li>
					</ul>
				</div>
			</div>
		</div>
    <!-- Breadcrumbs_end -->
    <div >
      <h1 class="table-title">訂單明細</h1>
      <div class="table-responsive">
        <table
          class="table table-hover"
          id="table-data"
        >
          <thead>
            <tr >
              <th>#</th>
              <th>房型名稱</th>
              <th>訂單日期</th>
              <th>金額</th>
              <th>狀態</th>
              <th>操作</th>

            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>

  </div>
  <!-- Footer_start -->
  <div id="footer"></div>
  <!-- Footer_end -->
  <!-- Modal_start -->
  <div
    class="modal fade"
    id="exampleModal"
    tabindex="-1"
    aria-labelledby="exampleModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
                <div class="modal-header">
                  <h3 class="modal-title" id="modelTitle"></h3>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>

                <div class="modal-body">
                  <form>
                    <div class="mb-3">
                      <label for="exampleInputPassword1" class="form-label"
                        >房型名稱</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="roomName"
                        disabled
                        
                      />
                    </div>
                    <div class="mb-3">
                      <label id="score" class="form-label"
                        >評價</label
                      >
                      <ul class="comment box" id="star0">
                        <li>☆</li>
                        <li>☆</li>
                        <li>☆</li>
                        <li>☆</li>
                        <li>☆</li>
                      </ul>
                    </div>
                    <div class="mb-3">
                      <label
                        for="feedback"
                        class="form-label"
                        style="margin-top: 20px"
                        >回饋建議</label
                      >
                      <textarea  type="text"  class="form-control"  id="feedback"  ></textarea>
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    取消
                  </button>

                  <button id="submit" type="button" class="btn btn-primary">
                    送出
                  </button>
                </div>
      </div>
    </div>
  </div>
  <!-- Modal_end -->
    </div>
  </body>
</html>
<!-- 引入 header / footer /scrollTop-->
<script> 
  $(function(){
    $("#header").load("../../header.html"); 
    $("#footer").load("../../footer.html"); 
    $("#scrollTop").load("../../scrollTop.html"); 

  });
</script> 
<!-- Ａos 淡入淡出特效_start -->
<script type="module">

  function refresh_chart(str_cameo_motion_component_tag_name) {
    console.log("str_cameo_motion_component_tag_name");
    console.log(str_cameo_motion_component_tag_name);
    let cameo_motion_component = document.getElementsByTagName(
      str_cameo_motion_component_tag_name)[0];
    console.log("cameo_motion_component");
    console.log(cameo_motion_component);
    console.log("cameo_motion_component.chart");
    console.log(cameo_motion_component.chart);
    cameo_motion_component.chart.appear();
    cameo_motion_component.chart.series.each(function (series) {
      series.appear();
    });
  }

  AOS.init({
    duration: 1000, // values from 0 to 3000, with step 50ms
    offset: 90 // offset (in px) from the original trigger point

  });
  $(function () {
    var winHeight = $(window).height();
    $(".scrolldown").on("click", function () {
      $("html,body").stop(true, false).animate(
        {
          scrollTop: winHeight
        },
        800
      );
      return false;
    });
  });
  let ary_charts = [
    "cameo-divergent-stacked-bars",
    "cameo-run",
    "cameo-line",
    "cameo-rank",
    "cameo-multi-axis-prediction",
    "cameo-map-tw"
  ];
  for (let i = 1; i <= ary_charts.length; i++) {
    let str_aos = "aos:in:chart-" + i;
    document.addEventListener(str_aos, ({ detail }) => {
      refresh_chart(ary_charts[i - 1]);
    });
  }
</script>
<!-- Ａos 淡入淡出特效_end -->
<!-- jquery -->
<script src="../../js/jquery-3.2.1.min.js"></script>
<!-- bootstrap -->
<script src="../../styles/bootstrap4/popper.js"></script>
<script src="../../styles/bootstrap4/bootstrap.min.js"></script>
<!-- 輪播 -->
<script src="../../plugins/OwlCarousel2-2.2.1/owl.carousel.js"></script>
<!-- SweetAlert2 -->
<script src="../../alert.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/7.2.0/sweetalert2.all.min.js"></script>
<!-- AOS -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/aos/3.0.0-beta.6/aos.js"
  integrity="sha512-tnNM6PPNOVfZ5sGPw6hThCrcUBeqt2mVEk3EAj8tCtuMHqbuVm5/HsZagrr8W2aaFE+6rKIByGwQbEnmodrYVg=="
  crossorigin="anonymous"
>
</script>
<!-- 網址取參數_start -->
<script>
//先取得網址字串，假設此頁網址為「index.aspx?id=U001&name=GQSM」
var url = location.href;
//再來用去尋找網址列中是否有資料傳遞(QueryString)
if(url.indexOf('?')!=-1)
{
    //之後去分割字串把分割後的字串放進陣列中
    var ary1 = url.split('?');
    //此時ary1裡的內容為：
    //ary1[0] = 'index.aspx'，ary2[1] = 'id=U001&name=GQSM'
    //下一步把後方傳遞的每組資料各自分割
    var ary2 = ary1[1].split('&');
    //此時ary2裡的內容為：
    //ary2[0] = 'id=U001'，ary2[1] = 'name=GQSM'
    //最後如果我們要找id的資料就直接取ary[0]下手，name的話就是ary[1]
    var ary3 = ary2[0].split('=');
    //此時ary3裡的內容為：
    //ary3[0] = 'id'，ary3[1] = 'U001'
    //取得id值
    var id = ary3[1];
    console.log(id)
}
</script>
<!-- 網址取參數_end -->

<!-- API_start -->
<script
src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
crossorigin="anonymous"
></script>

<script
src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"
crossorigin="anonymous"
></script>
<script
src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"
crossorigin="anonymous"
></script>
<script
src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.20.0/axios.min.js"
crossorigin="anonymous"
></script>
<script>
  var data_table = [];
  var roomOrderId = '';
  $.extend(true, $.fn.dataTable.defaults, {
    paging: true,
    lengthChange: false,
    searching: false,
    processing: true,
    ordering: false,
    info: false,
    responsive: false,
    autoWidth: false,
    pageLength: 5,
    dom: '<"top"f>rtlip'
  });

  $("#table-data").DataTable({
    ajax: function (data, callback, settings) {
      axios
        .get("https://jsonplaceholder.typicode.com/users")
        .then((result) => {
          console.log(result);
          callback({ data: result.data });
        })
        .catch((err) => {
          console.log(err);
        });
    },
    columns: [
      {
        data: null,
        render: function (data, type, row, meta) {
          return meta.row + 1;
        }
      },
      {
        data: null,
        render: function (data, type, row) {
          return data.name;
        }
      },
      {
        data: null,
        render: function (data, type, row, meta) {
          return data.date;
        }
      },
      {
        data: null,
        render: function (data, type, row, meta) {
          return data.count;
        }
      },
      
      {
        data: null,
        render: function (data, type, row, meta) {
          return '<button id="cancelOrder" type="button" class="btn btn-outline-warning btn-cancel-order">取消訂單</button>';
        }
      },
      {
        data: null,
        render: function (data, type, row, meta) {
          return '<button class="btn btn-primary btn-edit" data-bs-toggle="modal" data-bs-target="#exampleModal">評價</button>';
        }
      },
    ]
  });
  $(document).on("click", ".btn-edit", function () {
    let current_row = $(this).parents("tr");
    if (current_row.hasClass("child")) {
      current_row = current_row.prev();
    }
    let table = $("#table-data").DataTable();
    let data = table.row(current_row).data();
    roomOrderId = data.email;
    let modal = $('#exampleModal')
    modal.find('#modelTitle').text(data.email);
    modal.find('#roomName').val(data.name);
  });

  const refreshTable = (tablename) => {
    let table = $(tablename).DataTable();
    table.ajax.reload(null, false);
  };

  const drawTable = (tablename, obj) => {
    let xtable = $(tablename).DataTable();
    xtable.clear();
    xtable.rows.add(obj);
    xtable.draw();
  };
</script>
<!-- API_end-->
<!-- cancel order button_start-->
<script>
    $(document).on("click", ".btn-cancel-order", function () {
    // 取data
    let current_row = $(this).parents("tr");
    if (current_row.hasClass("child")) {
      current_row = current_row.prev();
    }
    let table = $("#table-data").DataTable();
    let data = table.row(current_row).data();
    swal({
      title:  `${data.name}`,
      text: "確定要取消此筆訂單?",
      type: "warning",
      cancelButtonText:'取消',
      confirmButtonText: "確定",
      reverseButtons: true,
      showCancelButton: true
    }).then((result) => {
      if (result.value) {
        const cancelData = {
          orderStatus: false,
        }
        console.log(cancelData);
        $.ajax({
          type: "PUT",
          url: `/roomorders/${data.roomOrderId}`,
          data: JSON.stringify(cancelData),
          dataType: "json",
          encode: true
        }).done(function(data) {
            swal({
              type: "success",
              title: "取消成功!",
            });
            refreshTable("#table-data");
        }).fail(function (jqXHR, textStatus, errorThrown) { 
            console.log('error');

        })
      } 
    });
  });
</script>

<!-- cancel order button_end-->
<!-- model -->
<script
src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
crossorigin="anonymous"
>
</script>
<!-- 評價星星 -->
<script>
  var star = '';
  $(".box li").click(function(){
   var index = $(this).index();
    $(this).parent().attr("score",index+1);
    var parentId = $(this).parent().attr("id");
    $("#"+parentId).find("li").css("background-image","url('star.png')");
    for(var i=0;i<=index;i++){
    $("#"+parentId).find("li").eq(i).css("background-image","url('star_active.png')");
    }
    var score = $("#"+parentId).attr("score");
    star = score;
    $("#score").text("評價: "+score+".0");
  });
  $(function() {
    // ☆ ★
    var wjx_all = "★"; // 实心五角星
    var wjx_none = "☆"; // 空心五角星
    // 1. 给所有的li元素绑定鼠标键入的事件
    $(".comment").on("mouseenter", "li",
    function() {
        /*// 2. 让当前元素内容变为实心五角星，
                // 并且让当前这个素元之前的所有元素的内容也变为实心五角星
                // prevAll() 表示：获取指定元素之前所有元素
                $(this).text(wjx_all).prevAll("li").text(wjx_all);
                // 3. 让当前这个元素之后的所有元素变为空心五角星
                $(this).nextAll("li").text(wjx_none);*/

        $(this).text(wjx_all).prevAll("li") // 此处，修改了链式编程的结构
        .text(wjx_all).end() // end() 恢复链式编程被修改之前的一个状态
        .nextAll("li").text(wjx_none);
    });

    // 让鼠标离开所有的li元素的时候，变为空心五角星
    $(".comment").on("mouseleave",
    function() {
        $(this).children("li").text(wjx_none);

        /*// 让具有标识类的元素 以及之前的所有元素都设置为实心五角星*/
        /*$(".clicked").text(wjx_all).prevAll("li").text(wjx_all); */
        /*// 让具有标识类的元素后面的所有元素都设置空心五角星*/
        /*$(".clicked").nextAll("li").text(wjx_none);*/
        $(".clicked").text(wjx_all).prevAll("li").text(wjx_all).end().nextAll("li").text(wjx_none);

    });

    // 单击评分：鼠标离开ul的时候，如何知道单击了哪一个元素？
    // addClass -> 添加类
    $(".comment").on("click", "li",
    function() {
        // 给当前元素添加类，这个类的作用： 标识
        // 要给 其他的兄弟元素移除掉这个类
        $(this).addClass("clicked").siblings("li").removeClass("clicked").removeClass('commentCheck');
        
    });
});

$("#submit").on("click",
    function() {
      console.log(roomOrderId)
      const formData = JSON.stringify({
        roomName: $("#roomName").val(),
        feedback: $("#feedback").val(),
        star: star
      });
      console.log(formData)
      $.ajax({
        type: "PUT",
        url: `/roomorders/${roomOrderId}`,
        data: formData,
        dataType: "json",
        encode: true
      }).done(function(data) {
          swal({
            type: "success",
            title: "編輯成功!",
          });
          $('#exampleModal').modal('toggle')
          refreshTable("#table-data");
      }).fail(function (jqXHR, textStatus, errorThrown) { 
          console.log('error');
      })
});
</script>


